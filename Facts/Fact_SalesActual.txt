CREATE OR REPLACE TABLE Fact_SalesActual
(
     DimProductID           INTEGER CONSTRAINT FK_DimProductIDSalesActual FOREIGN KEY REFERENCES Dim_Product(DimProductID), 
     DimStoreID             INTEGER CONSTRAINT FK_DimStoreIDSalesActual FOREIGN KEY REFERENCES Dim_Store(DimStoreID), 
     DimResellerID          INTEGER CONSTRAINT FK_DimResellerIDSalesActual FOREIGN KEY REFERENCES Dim_Reseller(DimResellerID),
     DimCustomerID          INTEGER CONSTRAINT FK_DimCustomerIDSalesActual FOREIGN KEY REFERENCES Dim_Customer(DimCustomerID),
     DimChannelID           INTEGER CONSTRAINT FK_DimChannelIDSalesActual FOREIGN KEY REFERENCES Dim_Channel(DimChannelID), 
     DimSaleDateID          NUMBER(9) CONSTRAINT FK_DimSaleDateIDSalesActual FOREIGN KEY REFERENCES Dim_Date(DATE_PKEY),
     DimLocationID          INTEGER CONSTRAINT FK_DimLocationIDSalesActual FOREIGN KEY REFERENCES Dim_Location(DimLocationID),
     SourceSalesHeaderID    INT, 
     SourceSalesDetailID    INT, 
     SaleAmount             FLOAT,
     SaleQuantity           INT,
     SaleUnitPrice          FLOAT, 
     SaleExtendedCost       FLOAT, 
     SaleTotalProfit        FLOAT
);

INSERT INTO Fact_SalesActual(
  DimProductID,
  DimStoreID,
  DimResellerID,
  DimCustomerID,
  DimChannelID,
  DimSaleDateID,
  DimLocationID,
  SourceSalesHeaderID,
  SourceSalesDetailID,
  SaleAmount,
  SaleQuantity,
  SaleUnitPrice, 
  SaleExtendedCost,
  SaleTotalProfit
)
SELECT
    DP.DIMPRODUCTID,
    NVL(DS.DIMSTOREID, -1) AS DIMSTOREID,
    NVL(DR.DIMRESELLERID, -1) AS DIMRESELLERID,
    NVL(DC.DIMCUSTOMERID, -1) AS DIMCUSTOMERID,
    DCH.DIMCHANNELID,
    CAST(REPLACE(REPLACE(CAST(SH.DATE AS DATE), '00', '20'), '-', '') AS NUMBER(9))  AS DimSaleDateID,
    COALESCE(DS.DIMLOCATIONID, DC.DIMLOCATIONID, DR.DIMLOCATIONID, -1) AS DIM_LOCATIONID,
    SH.SALESHEADERID AS SourceSalesHeaderID,
    SD.SALESDETAILID AS SourceSalesDetailID,
    SD.SALESAMOUNT AS SaleAmount,
    SD.SALESQUANTITY AS SaleQuantity,
    CASE 
        WHEN DR.DIMRESELLERID IS NOT NULL 
        THEN DP.PRODUCTWHOLESALEPRICE 
        ELSE DP.PRODUCTRETAILPRICE 
    END AS SALE_UNIT_PRICE,
    FLOOR(DP.PRODUCTCOST * SD.SALESQUANTITY,2) AS SaleExtendedCost,
    FLOOR(SD.SALESAMOUNT - SaleExtendedCost,2) AS SaleTotalProfit
FROM SALES_HEADER SH
INNER JOIN SALES_DETAILS SD ON SH.SALESHEADERID = SD.SALESHEADERID
INNER JOIN DIM_PRODUCT DP ON SD.PRODUCTID = DP.SOURCEPRODUCTID
INNER JOIN DIM_CHANNEL DCH ON SH.CHANNELID = DCH.SOURCECHANNELID
LEFT JOIN DIM_STORE DS ON SH.STOREID = DS.DIMSTOREID
LEFT JOIN DIM_RESELLER DR ON SH.RESELLERID = DR.SOURCERESELLERID
LEFT JOIN DIM_CUSTOMER DC ON SH.CUSTOMERID = DC.SOURCECUSTOMERID


SELECT * FROM Fact_SalesActual
SELECT * FROM DIM_RESELLER
SELECT * FROM DIM_CHANNEL
SELECT * FROM SALES_HEADER
SELECT * FROM SALES_DETAILS
SELECT * FROM DIM_PRODUCT
SELECT * FROM DIM_CUSTOMER
SELECT * FROM FACT_SRCSALESTARGET